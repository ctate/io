# Middleware

You can add middleware to FastAPI applications.

A "middleware" is a function that processes every request before it is handled by any specific path operation and every response before it is returned.

- It takes each request that comes to your application.
- It can modify the request or execute any necessary code.
- It passes the request to be processed by the rest of the application (by some path operation).
- It takes the response generated by the application.
- It can modify the response or execute any necessary code.
- It returns the response.

**Technical Details**: If you have dependencies with `yield`, the exit code will run after the middleware. Background tasks will run after all middleware.

## Create a Middleware

To create a middleware, use the decorator `@app.middleware("http")` on top of a function.

The middleware function receives:

- The `request`.
- A function `call_next` that receives the `request` as a parameter.
  - This function passes the request to the corresponding path operation.
  - It returns the response generated by the corresponding path operation.
- You can further modify the response before returning it.

```Python
{!../../docs_src/middleware/tutorial001.py!}
```

**Tip**: Custom proprietary headers can be added using the 'X-' prefix. If you want a client in a browser to see custom headers, add them to your CORS configurations using the parameter `expose_headers` documented in Starlette's CORS docs.

**Technical Details**: You could also use `from starlette.requests import Request`. FastAPI provides it as a convenience, but it comes directly from Starlette.

### Before and After the Response

You can run code with the request before any path operation receives it and after the response is generated, before returning it. For example, you could add a custom header `X-Process-Time` containing the time in seconds that it took to process the request and generate a response:

```Python
{!../../docs_src/middleware/tutorial001.py!}
```

**Tip**: Use `time.perf_counter()` instead of `time.time()` for more precise measurements.

## Other Middlewares

You can read more about other middlewares in the Advanced User Guide: Advanced Middleware. You will learn how to handle Cross-Origin Resource Sharing (CORS) with a middleware in the next section.